<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Todo List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light"> 
    
    <%- include('nav.ejs') %> 
    <div class="container mt-5"> 
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">ğŸ“… í•  ì¼ ëª©ë¡</h2>
            <a href="/write" class="btn btn-primary">+ ìƒˆ ê¸€ ì“°ê¸°</a>
        </div>

        <div class="list-group">
            <% for (let i = 0; i < posts.length; i++) { %>
                <div id="post-<%= posts[i]._id %>" class="list-group-item d-flex justify-content-between align-items-center p-3 shadow-sm mb-2 rounded">
                    <div>
                        <a href="/detail/<%= posts[i]._id %>" class="text-decoration-none link-dark fw-bold">
                            <%= posts[i].title %>
                        </a>
                        <p class="mb-1 text-secondary"><%= posts[i].content %></p>
                        
                        <div class="mt-2">
                            <span class="badge bg-warning text-dark">ë§ˆê°: <%= posts[i].dueDate %></span>
                            
                            <small class="text-muted ms-2" style="font-size: 0.8em;">
                                ì‘ì„±ì¼: <%= posts[i].createdAt.toLocaleDateString() %>
                            </small>
                        </div>
                    </div>

                    <%# ìˆ˜ì •ê¸°ëŠ¥ ì¶”ê°€ %>
                    <div class="d-flex align-items-center gap-2">
                        <a href="/edit/<%= posts[i]._id %>" class="btn btn-outline-warning btn-sm">ìˆ˜ì •</a>
                    
                    <% if (false) { %>
                    <%# ì‚­ì œê¸°ëŠ¥ ì¶”ê°€ %>
                        <form action="/delete/<%= posts[i]._id %>" method="POST" class="m-0">
                            <button type="submit" class="btn btn-outline-danger btn-sm">ì‚­ì œ</button>
                        </form>
                    <% } %>

                        <button 
                            type="button" 
                            class="btn btn-outline-danger btn-sm delete-btn" 
                            data-id="<%= posts[i]._id %>">
                            ì‚­ì œ
                        </button>
                    </div>
                    
                </div>
            <% } %>
        </div>
    </div>
    <%- include('pagination.ejs', { currentPage: currentPage, totalPages: totalPages }) %>


<script>
    // 1. ëª¨ë“  ì‚­ì œ ë²„íŠ¼ì„ ì„ íƒí•©ë‹ˆë‹¤.
    const deleteButtons = document.querySelectorAll('.delete-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', async function(e) {
            // 2. ë²„íŠ¼ì˜ ì£¼ë¨¸ë‹ˆ(data-id)ì—ì„œ ê²Œì‹œê¸€ IDë¥¼ êº¼ëƒ…ë‹ˆë‹¤.
            const postId = e.target.dataset.id;

            // ì‹¤ìˆ˜ë¡œ ëˆ„ë¥´ëŠ” ê²ƒ ë°©ì§€
            if (!confirm('ã„¹ã…‡ ì‚­ì œí•¨?')) return;

            try {
                // 3. ì„œë²„ì— "ë¹„ë™ê¸°(AJAX)"ë¡œ ì‚­ì œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
                // ë§Œì•½ ì„œë²„ê°€ app.postë¡œ ë˜ì–´ ìˆë‹¤ë©´ methodë¥¼ 'POST'ë¡œ ë°”ê¾¸ì„¸ìš”!
                const response = await fetch(`/delete/${postId}`, {
                    method: 'DELETE' 
                });

                // ì„œë²„ì˜ ì‘ë‹µì„ JSONìœ¼ë¡œ ë³€í™˜
                const result = await response.json();

                if (response.ok) {
                    // 4. [ì„±ê³µ ì‹œ] í•´ë‹¹ IDë¥¼ ê°€ì§„ ì¤„(div)ì„ í™”ë©´ì—ì„œ ì¦‰ì‹œ ì œê±°!
                    document.getElementById(`post-${postId}`).remove();
                    console.log('ì„œë²„ ì‘ë‹µ:', result.message);
                } else {
                    alert('ì„œë²„ì—ì„œ ì‚­ì œë¥¼ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('í†µì‹  ì—ëŸ¬:', error);
                alert('ì„œë²„ì™€ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì„œë²„ê°€ ì¼œì ¸ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!)');
            }
        });
    });
</script>

</body>
</html>